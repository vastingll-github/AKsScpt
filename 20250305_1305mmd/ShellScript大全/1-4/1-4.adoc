[[GlobalHeader-react-component-0e8fafc0-b191-46b1-b097-238556bd59f4]]
image:~//home/stingll/GIT/Github-vastingll/20250305_1305mmd/ShellScript大全/1-4/1-4_2.svg

[.material-symbols-outlined .style-18lpml7]#search#

[.material-symbols-outlined .style-v2p563]#search#[.style-1afofdy]#Search#

link:/login?callback_action=login_or_signup&redirect_to=%2Fikngtty%2Fitems%2Fc179053b0dd4f811c4d1&realm=qiita[Login]link:/signup?callback_action=login_or_signup&redirect_to=%2Fikngtty%2Fitems%2Fc179053b0dd4f811c4d1&realm=qiita[Signup]

[.material-symbols-outlined .style-18lpml7]#search#

. link:/[Trend]
. link:/question-feed[Question]
. link:/official-events[Official Event]
. link:/official-columns[Official
Column[.material-symbols-outlined .style-1o3zxqp]##open_in_new##]
. link:/organizations[Organization]

[[AlertMessage-react-component-da0c1e8e-58de-4454-895b-9bce07143e49]]

[[PersonalArticlePage-react-component-c9d3121e-c27c-440a-98a8-73e97d985953]]
image:~//home/stingll/GIT/Github-vastingll/20250305_1305mmd/ShellScript大全/1-4/1-4_22.svg

link:/ikngtty/items/c179053b0dd4f811c4d1/likers[9]

Go to list of users who liked

image:~//home/stingll/GIT/Github-vastingll/20250305_1305mmd/ShellScript大全/1-4/1-4_28.svg

[.style-1vem4tk]#7#

image:~//home/stingll/GIT/Github-vastingll/20250305_1305mmd/ShellScript大全/1-4/1-4_32.svg

image:~//home/stingll/GIT/Github-vastingll/20250305_1305mmd/ShellScript大全/1-4/1-4_34.svg

image:~//home/stingll/GIT/Github-vastingll/20250305_1305mmd/ShellScript大全/1-4/1-4_36.svg

[.material-symbols-outlined .style-v2p563]#more_horiz#

Delete article

[.material-symbols-outlined .style-v2p563]#close#

Deleted articles cannot be recovered.

Draft of this article would be also deleted.

Are you sure you want to delete this article?

Cancel

Delete[.material-symbols-outlined .is-fill .style-1jvcm2e]##delete##

[.material-symbols-outlined .is-fill .style-1l7bzw8]#info#

More than 5 years have passed since last update.

link:/ikngtty[]

image:https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F140384%2Fprofile-images%2F1473859692?ixlib=rb-4.0.0&auto=compress%2Cformat&lossless=0&w=48&s=c11a468b452194729ebb3daf61f72872[https://qiita-user-profile-images.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F140384%2Fprofile-images%2F1473859692?ixlib=rb-4.0,width=24,height=24]

@ikngtty[.style-15fzge]##(Tetsuya
Ikenaga)##[.style-1e7czb6]#inlink:/organizations/realglobe[image:https://qiita-organization-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-organization-image%2Fe563b8b07c9ded59e86fa16b6db6d5478a2defd1%2Foriginal.jpg%3F1554962223?ixlib=rb-4.0.0&auto=compress%2Cformat&s=de430e97cd9149d4c4f61bd40a6df1f2[https://qiita-organization-images.imgix.net/https%3A%2F%2Fs3-ap-northeast-1.amazonaws.com%2Fqiita-organization-image%2Fe563b8b07c9ded59e86fa16b6db6d5478a2defd1%2Foriginal.jpg%3F1554962223?ixlib=rb-4.0,width=20,height=20][.style-8uhtka]#株式会社リアルグローブ#]#

== シェルスクリプトプロジェクトにおける共通関数・定数の管理

* link:/tags/shellscript[ShellScript]
* link:/tags/posix[POSIX]

[.style-3k9iaf]#Last updated at 2019-05-19#[.style-3k9iaf]#Posted at
2019-01-06#

[[personal-public-article-body]]
== [#シェルスクリプトプロジェクトってなんやねん .fragment]##link:#%E3%82%B7%E3%82%A7%E3%83%AB%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E3%83%97%E3%83%AD%E3%82%B8%E3%82%A7%E3%82%AF%E3%83%88%E3%81%A3%E3%81%A6%E3%81%AA%E3%82%93%E3%82%84%E3%81%AD%E3%82%93[__]シェルスクリプトプロジェクトってなんやねん

世の中にそんな地獄案件がどれほどあるのか知りませんが、 +
とりあえず今自分は環境構築・設定ファイル同期用のスクリプト群を１つのリポジトリ（https://github.com/ikngtty/dotfiles[GitHub]）にまとめてます。 +
いわゆるdotfilesってやつです。

その中で、共通でよく使う定数やutil関数を括り出したい欲求が出てきました。 +
例えばこんなやつ↓

[.bold]#common.sh#

....
#!/bin/sh
set -Ceu

# 定数
login_shell=fish
config_dir_path="$HOME/Config"

# util関数
echo_with_color() {
  case "$1" in
    red)
      color_code='\e[31m'
      ;;
    green)
      color_code='\e[32m'
      ;;
    yellow)
      color_code='\e[33m'
      ;;
    magenta)
      color_code='\e[36m'
      ;;
  esac
  shift

  printf "$color_code"
  for msg in "$@"; do
    printf "$(echo "$msg" | sed \
      -e 's/<b>/\\e\[1m/g'\
      -e 's/<\/b>/\\e[m\'"$color_code"'/g')"
  done
  printf '\e[m'
  echo # 改行用
}

echo_err() {
  echo_with_color red "<b>ERROR</b>: " "$@"
}

echo_log() {
  echo_with_color magenta "LOG: " "$@"
}
....

ところがどっこい、残念ながらシェルスクリプトには変数やら関数やらオブジェクトやらをexport/importするようなモジュール化の仕組みはありません。

== [#最初に思いついたやつ .fragment]##link:#%E6%9C%80%E5%88%9D%E3%81%AB%E6%80%9D%E3%81%84%E3%81%A4%E3%81%84%E3%81%9F%E3%82%84%E3%81%A4[__]最初に思いついたやつ

外部スクリプトに対してできることは、

* 実行する
* `.`（ドット）コマンドで読み込む。（Bashでは`source`コマンドとも。）

の2択しかありません。 +
実行するだけでは変数や関数は結局ロードできないので、ドットコマンドで読み込んでみます。

[.bold]#main.sh#

....
#!/bin/sh
set -Ceu

# プロジェクトフォルダの絶対パス取得
cd "$(dirname "$0")"  # このスクリプトがあるフォルダ
cd ./                 # ＝プロジェクトフォルダとします。
dir_project=$(pwd)

# 共通部分読み込み
. "$dir_project/common.sh"

# 使用
echo_with_color yellow 'わぁい'"$login_shell"' あかり'"$login_shell"'大好き'
....

https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F140384%2Ff78bb0e7-e71f-fbee-004f-90270aa99872.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=006dab2a66bc6a58baa4e4f3deac7b6a[image:https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F140384%2Ff78bb0e7-e71f-fbee-004f-90270aa99872.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=006dab2a66bc6a58baa4e4f3deac7b6a[image.png]]

できました。

=== [#問題点 .fragment]##link:#%E5%95%8F%E9%A1%8C%E7%82%B9[__]問題点

名前空間が区切られてないので、`main.sh`と`common.sh`が密結合なんですよね。 +
互いの変数・関数が流出して良からぬ動きをするかもしれない。

実は上の例ではわざとバグりそうな穴を作ってあります。

[.bold]#（続き）main.sh#

....
color_code='イェ〜イ　エンジニア見てる〜？　実装失敗してどうだった？'
echo_with_color RED 'あなたは赤い部屋が好きですか？'

echo_with_color green 'グリーン姉さん'
echo $color_code
....

https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F140384%2F202caddc-7ff1-9fd3-e386-54183987e205.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=0489314f4c054d533904786cf4165a15[image:https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F140384%2F202caddc-7ff1-9fd3-e386-54183987e205.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=0489314f4c054d533904786cf4165a15[image.png]] +
`color_code`変数が双方向に流出しています。 +
関数スコープが無いせいと言えなくも無いですが、良くない状況なのは確かです。

== [#解決策 .fragment]##link:#%E8%A7%A3%E6%B1%BA%E7%AD%96[__]解決策

ドットコマンドがダメなら実行するしか無いですね。

実行可能なスクリプトファイルっていうのは、すなわちコマンドです。 +
全部コマンドに落とし込んでみましょう。 +
コマンド同士なら色々流出することはないです。

小さなコマンドの組み合わせで大きなことを実現する。 +
UNIX哲学の基本でしたね。

[.bold]#util/project_const.sh#

....
#!/bin/sh
set -Ceu

case "$1" in
  login_shell)
    echo fish
    ;;
  config_dir_path)
    echo "$HOME/Config"
    ;;
  *)
    exit 1
    ;;
esac
....

[.bold]#util/echo_with_color.sh#

....
#!/bin/sh
set -Ceu

case "$1" in
  red)
    color_code='\e[31m'
    ;;
  green)
    color_code='\e[32m'
    ;;
  yellow)
    color_code='\e[33m'
    ;;
  magenta)
    color_code='\e[36m'
    ;;
esac
shift

printf "$color_code"
for msg in "$@"; do
  printf "$(echo "$msg" | sed \
    -e 's/<b>/\\e\[1m/g'\
    -e 's/<\/b>/\\e[m\'"$color_code"'/g')"
done
printf '\e[m'
echo # 改行用
....

[.bold]#util/echo_err.sh#

....
#!/bin/sh
set -Ceu

cd "$(dirname "$0")"  # このスクリプトがあるフォルダに移動

./echo_with_color.sh red "<b>ERROR</b>: " "$@"
....

[.bold]#util/echo_log.sh#

....
#!/bin/sh
set -Ceu

cd "$(dirname "$0")"  # このスクリプトがあるフォルダに移動

./echo_with_color.sh magenta "LOG: " "$@"
....

少々手間ですがこれで割と堅牢になりました。 +
使ってみます。

[.bold]#main.sh#

....
#!/bin/sh
set -Ceu

# プロジェクトフォルダの絶対パス取得
cd "$(dirname "$0")"  # このスクリプトがあるフォルダ
cd ./                 # ＝プロジェクトフォルダとします。
dir_project=$(pwd)
cd util
dir_util=$(pwd)

# 使用
login_shell="$($dir_util/project_const.sh login_shell)"
"$dir_util/echo_with_color.sh" yellow 'わぁい'"$login_shell"' あかり'"$login_shell"'大好き'

color_code='イェ〜イ　エンジニア見てる〜？　実装失敗してどうだった？'
"$dir_util/echo_with_color.sh" RED 'あなたは赤い部屋が好きですか？'

"$dir_util/echo_with_color.sh" green 'グリーン姉さん'
echo $color_code
....

https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F140384%2F9649dbec-5642-5f9b-a73f-80467e89aef9.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=083f28421d15f9d04b1345fde0715d44[image:https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F140384%2F9649dbec-5642-5f9b-a73f-80467e89aef9.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=083f28421d15f9d04b1345fde0715d44[image.png]]

「`color_code`なんて宣言してねえだろゴルァ！」的なことを言われたので、`main.sh`で仕込んだ`color_code`が流出して悪さすることはなくなってるのが確認できました。

[.bold]#（修正）main.sh#

....
# RED -> red
"$dir_util/echo_with_color.sh" red 'あなたは赤い部屋が好きですか？'
....

https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F140384%2F74abd3bd-31a3-a0f8-15f8-df1b74049ea6.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=3d1b947411ecbee31e08655f4fbf7c54[image:https://qiita-user-contents.imgix.net/https%3A%2F%2Fqiita-image-store.s3.amazonaws.com%2F0%2F140384%2F74abd3bd-31a3-a0f8-15f8-df1b74049ea6.png?ixlib=rb-4.0.0&auto=format&gif-q=60&q=75&s=3d1b947411ecbee31e08655f4fbf7c54[image.png]]

もちろん、`util/echo_with_color.sh`から`main.sh`への流出も起きてません。

=== [#より綺麗に .fragment]##link:#%E3%82%88%E3%82%8A%E7%B6%BA%E9%BA%97%E3%81%AB[__]より綺麗に

いちいちファイルパスを指定して呼び出すのも長ったらしいです。 +
最初にまとめてエイリアス関数を定義しちゃいましょう。

[.bold]#main.sh#

....
#!/bin/sh
set -Ceu

# プロジェクトフォルダの絶対パス取得
cd "$(dirname "$0")"  # このスクリプトがあるフォルダ
cd ./                 # ＝プロジェクトフォルダとします。
dir_project=$(pwd)
cd util
dir_util=$(pwd)

# インポート
## util関数
echo_with_color() {
  $dir_util/echo_with_color.sh "$@"
}
project_const() {
  $dir_util/project_const.sh "$@"
}
## 定数
login_shell="$(project_const login_shell)"

# 使用
echo_with_color yellow 'わぁい'"$login_shell"' あかり'"$login_shell"'大好き'

color_code='イェ〜イ　エンジニア見てる〜？　実装失敗してどうだった？'
echo_with_color red 'あなたは赤い部屋が好きですか？'

echo_with_color green 'グリーン姉さん'
echo $color_code
....

import文ライクな使用感になりました。 +
依存関係がまとまってていい感じ。

== [#感想 .fragment]##link:#%E6%84%9F%E6%83%B3[__]感想

マイクロサービスアーキテクチャって感じ（多分違う）。

あ、ここでは省略しましたが、本当はもっと引数の数チェックしたりエラーメッセージちゃんとしたりステータスコード整備したりした方が良さげです。

image:~//home/stingll/GIT/Github-vastingll/20250305_1305mmd/ShellScript大全/1-4/1-4_359.svg

link:/ikngtty/items/c179053b0dd4f811c4d1/likers[9]

Go to list of users who liked

image:~//home/stingll/GIT/Github-vastingll/20250305_1305mmd/ShellScript大全/1-4/1-4_365.svg

[.style-1129w32]#7#

link:#comments[[.material-symbols-outlined .style-n5k90r]##comment##1]

Go to list of comments

Register as a new user and use Qiita more conveniently

. You get articles that match your needs
. You can efficiently read back useful information
. You can use dark theme

https://help.qiita.com/ja/articles/qiita-login-user[What you can do with
signing up]

link:/signup?callback_action=login_or_signup&redirect_to=%2Fikngtty%2Fitems%2Fc179053b0dd4f811c4d1&realm=qiita[Sign
up]link:/login?callback_action=login_or_signup&redirect_to=%2Fikngtty%2Fitems%2Fc179053b0dd4f811c4d1&realm=qiita[Login]

image:~//home/stingll/GIT/Github-vastingll/20250305_1305mmd/ShellScript大全/1-4/1-4_385.svg

link:/ikngtty/items/c179053b0dd4f811c4d1/likers[9]

Go to list of users who liked

image:~//home/stingll/GIT/Github-vastingll/20250305_1305mmd/ShellScript大全/1-4/1-4_391.svg

[.style-1vem4tk]#7#

[.material-symbols-outlined .style-v2p563]#more_horiz#

Delete article

[.material-symbols-outlined .style-v2p563]#close#

Deleted articles cannot be recovered.

Draft of this article would be also deleted.

Are you sure you want to delete this article?

Cancel

Delete[.material-symbols-outlined .is-fill .style-1jvcm2e]##delete##

[[GlobalFooter-react-component-3c54034f-9839-4e0b-85eb-4c3afe5b3a2c]]
image:~//home/stingll/GIT/Github-vastingll/20250305_1305mmd/ShellScript大全/1-4/1-4_412.svg

How developers code is here.

[.small]#© 2011-2025[.style-15fzge]##Qiita Inc.###

Guide & Help

* link:/about[About]
* link:/terms[Terms]
* link:/privacy[Privacy]
* http://help.qiita.com/ja/articles/qiita-community-guideline[Guideline]
* https://help.qiita.com/ja/articles/others-brand-guideline[Media Kit]
* https://github.com/increments/qiita-discussions/discussions/116[Feedback/Requests]
* https://help.qiita.com[Help]
* https://business.qiita.com/?utm_source=qiita&utm_medium=referral&utm_content=footer[Advertisement]

Contents

* link:/release-notes[Release Note]
* link:/official-events[Official Event]
* link:/official-columns[Official Column]
* link:/advent-calendar/2024[Advent Calendar]
* link:/qiita-award[Qiita Award]
* link:/white_papers/2024[Engineer White Paper]
* link:/api/v2/docs[API]

Official Accounts

image:~//home/stingll/GIT/Github-vastingll/20250305_1305mmd/ShellScript大全/1-4/1-4_441.svg
image:~//home/stingll/GIT/Github-vastingll/20250305_1305mmd/ShellScript大全/1-4/1-4_442.svg
image:~//home/stingll/GIT/Github-vastingll/20250305_1305mmd/ShellScript大全/1-4/1-4_443.svg
* https://www.facebook.com/qiita/[Facebook]
* https://www.youtube.com/@qiita5366[YouTube]
* https://open.spotify.com/show/4E7yCLeCLeQUsNqM4HXFXA[Podcast]

Our service

* https://teams.qiita.com/[Qiita Team]
* https://zine.qiita.com?utm_source=qiita&utm_medium=referral&utm_content=footer[Qiita
Zine]
* https://suzuri.jp/qiita[Official Shop]

Company

* https://corp.qiita.com/company[About Us]
* https://corp.qiita.com/jobs/[Careers]
* https://blog.qiita.com[Qiita Blog]
* https://corp.qiita.com/releases/[News Release]

[[Snackbar-react-component-006012fa-efa2-4df4-acf5-34e3bfe55bf1]]

[[LoginModal-react-component-9a5e4352-9a58-44e7-a1f5-6eb583c22ec1]]

[[dataContainer]]
